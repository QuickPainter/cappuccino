
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cappuccino &#8212; Cappuccino 1.1.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cappuccino</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># from boundary_checker import *</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statistics</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>   
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../api.html#cappuccino.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">candidates_df_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the main function.</span>

<span class="sd">    Args:</span>
<span class="sd">        candidates_df_name (_type_): _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">main_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
   
    <span class="c1"># target_list = [&#39;NGC1052&#39;, &#39;NGC1172 &#39;, &#39;NGC1400&#39;, &#39;NGC1407&#39;, &#39;NGC2403&#39;]</span>
    <span class="c1"># target_list = [&#39;NGC584&#39;]</span>
    <span class="c1"># target_list = [&#39;HERCULES&#39;, &#39;HIZSS003&#39;, &#39;IC0010&#39;, &#39;IC0342&#39;, &#39;IC1613&#39;, &#39;LEOA&#39;, &#39;LEOII&#39;, &#39;LEOT&#39;, &#39;LGS3&#39;, &#39;MAFFEI1&#39;, &#39;MAFFEI2&#39;, &#39;MESSIER031&#39;, &#39;MESSIER033&#39;, &#39;MESSIER081&#39;, &#39;MESSIER101&#39;, &#39;MESSIER49&#39;, &#39;MESSIER59&#39;, &#39;MESSIER84&#39;, &#39;MESSIER86&#39;, &#39;MESSIER87&#39;, &#39;NGC0185&#39;, &#39;NGC0628&#39;, &#39;NGC0672 &#39;, &#39;NGC1052&#39;, &#39;NGC1172 &#39;, &#39;NGC1400&#39;, &#39;NGC1407&#39;, &#39;NGC2403&#39;]</span>
    <span class="c1"># load candidates database</span>

    <span class="n">target_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AND_II&#39;</span><span class="p">,</span><span class="s1">&#39;AND_I&#39;</span><span class="p">,</span> <span class="s1">&#39;AND_X&#39;</span><span class="p">,</span> <span class="s1">&#39;AND_XI&#39;</span><span class="p">,</span> <span class="s1">&#39;AND_XIV&#39;</span><span class="p">,</span> <span class="s1">&#39;AND_XVI&#39;</span><span class="p">,</span> <span class="s1">&#39;AND_XXIII&#39;</span><span class="p">,</span> <span class="s1">&#39;AND_XXIV&#39;</span><span class="p">,</span> <span class="s1">&#39;BOL520&#39;</span><span class="p">,</span> <span class="s1">&#39;CVNI&#39;</span><span class="p">,</span> <span class="s1">&#39;DDO210&#39;</span><span class="p">,</span> <span class="s1">&#39;DRACO&#39;</span><span class="p">,</span> <span class="s1">&#39;DW1&#39;</span><span class="p">,</span><span class="s1">&#39;HERCULES&#39;</span><span class="p">,</span> <span class="s1">&#39;HIZSS003&#39;</span><span class="p">,</span> <span class="s1">&#39;IC0010&#39;</span><span class="p">,</span> <span class="s1">&#39;IC0342&#39;</span><span class="p">,</span> <span class="s1">&#39;IC1613&#39;</span><span class="p">,</span> <span class="s1">&#39;LEOA&#39;</span><span class="p">,</span> <span class="s1">&#39;LEOII&#39;</span><span class="p">,</span> <span class="s1">&#39;LEOT&#39;</span><span class="p">,</span> <span class="s1">&#39;LGS3&#39;</span><span class="p">,</span> <span class="s1">&#39;MAFFEI1&#39;</span><span class="p">,</span> <span class="s1">&#39;MAFFEI2&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER031&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER033&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER081&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER101&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER49&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER59&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER84&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER86&#39;</span><span class="p">,</span> <span class="s1">&#39;MESSIER87&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC0185&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC0628&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC0672 &#39;</span><span class="p">,</span> <span class="s1">&#39;NGC1052&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC1172 &#39;</span><span class="p">,</span> <span class="s1">&#39;NGC1400&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC1407&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC2403&#39;</span><span class="p">,</span><span class="s1">&#39;NGC2683&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC2787&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC3193&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC3226&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC3344&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC3379&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4136&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4168&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4239&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4244&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4258&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4318&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4365&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4387&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4434&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4458&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4473&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4478&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4486B&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4489&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4551&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4559&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4564&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4600&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4618&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4660&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4736&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC4826&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC5194&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC5195&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC5322&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC5638&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC5813&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC5831&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC584&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC5845&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC5846&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC596&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC636&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC6503&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC6822&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC6946&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC720&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC7454 &#39;</span><span class="p">,</span> <span class="s1">&#39;NGC7640&#39;</span><span class="p">,</span> <span class="s1">&#39;NGC821&#39;</span><span class="p">,</span> <span class="s1">&#39;PEGASUS&#39;</span><span class="p">,</span> <span class="s1">&#39;SAG_DIR&#39;</span><span class="p">,</span> <span class="s1">&#39;SEXA&#39;</span><span class="p">,</span> <span class="s1">&#39;SEXB&#39;</span><span class="p">,</span> <span class="s1">&#39;SEXDSPH&#39;</span><span class="p">,</span> <span class="s1">&#39;UGC04879&#39;</span><span class="p">,</span> <span class="s1">&#39;UGCA127&#39;</span><span class="p">,</span> <span class="s1">&#39;UMIN&#39;</span><span class="p">]</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">main_dir</span><span class="o">+</span><span class="n">candidates_df_name</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_list</span><span class="p">:</span>        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running boundary checker for target:&quot;</span><span class="p">,</span><span class="n">target</span><span class="p">)</span>
        <span class="n">unique_h5_files</span><span class="p">,</span><span class="n">unique_nodes</span> <span class="o">=</span> <span class="n">get_all_h5_files</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="c1"># print total number of files</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span><span class="n">listElem</span><span class="p">)</span> <span class="k">for</span> <span class="n">listElem</span> <span class="ow">in</span> <span class="n">unique_h5_files</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> files&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">main_dir</span><span class="p">)</span>
        <span class="c1"># print(&quot;All files:&quot;,unique_h5_files)</span>
        <span class="c1"># reformed_unique_h5 = []</span>

        <span class="c1"># # make sure the spliced files don&#39;t get piled together by accident</span>
        <span class="c1"># for node in range(0,len(unique_nodes)):</span>
        <span class="c1">#     if unique_nodes[node] == &quot;splic&quot;:</span>
        <span class="c1">#         for file in unique_h5_files[node]:</span>
        <span class="c1">#             reformed_unique_h5.append(file)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         reformed_unique_h5.append(unique_h5_files[node])</span>

        <span class="c1"># print(&quot;Reformed files:&quot;,reformed_unique_h5)</span>


    <span class="c1"># skip spliced for now</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># if unique_nodes[0] != &quot;splic&quot;:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">unique_nodes</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_h5_files</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">unique_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;splic&quot;</span><span class="p">:</span>
                    <span class="n">h5_files</span> <span class="o">=</span> <span class="n">unique_h5_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">obs1</span> <span class="o">=</span> <span class="n">h5_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">obs2</span> <span class="o">=</span> <span class="n">h5_files</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">obs3</span> <span class="o">=</span> <span class="n">h5_files</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">obs4</span> <span class="o">=</span> <span class="n">h5_files</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">obs5</span> <span class="o">=</span> <span class="n">h5_files</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">obs6</span> <span class="o">=</span> <span class="n">h5_files</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">all_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs1</span><span class="p">,</span><span class="n">obs2</span><span class="p">,</span><span class="n">obs3</span><span class="p">,</span><span class="n">obs4</span><span class="p">,</span><span class="n">obs5</span><span class="p">,</span><span class="n">obs6</span><span class="p">)</span>
                    <span class="n">low_correlation_frequencies</span><span class="p">,</span><span class="n">scores</span><span class="o">=</span> <span class="n">main_boundary_checker</span><span class="p">(</span><span class="n">obs1</span><span class="p">,</span><span class="n">obs2</span><span class="p">,</span><span class="n">obs3</span><span class="p">,</span><span class="n">obs4</span><span class="p">,</span><span class="n">obs5</span><span class="p">,</span><span class="n">obs6</span><span class="p">)</span>
    
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">low_correlation_frequencies</span><span class="p">)):</span>
                        <span class="n">freq</span> <span class="o">=</span> <span class="n">low_correlation_frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">file_location</span> <span class="o">=</span> <span class="n">obs1</span>
                        <span class="n">candidates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_location</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">all_files</span><span class="p">,</span><span class="n">score</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>

                    <span class="n">candidates</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">main_dir</span><span class="o">+</span><span class="n">df_name</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skipping spliced files&quot;</span><span class="p">)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     print(f&quot;Sxkipping {target} b/c spliced&quot;)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX ERROR ON TARGET </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">)</span></div>
    

    

    


<div class="viewcode-block" id="get_all_h5_files"><a class="viewcode-back" href="../api.html#cappuccino.get_all_h5_files">[docs]</a><span class="k">def</span> <span class="nf">get_all_h5_files</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    We want to return groups of cadences</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="c1"># initialize list to store h5 files</span>
    <span class="n">h5_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># first change directory into the target directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

    <span class="c1"># we want to get all the unique nodes</span>
    <span class="n">unique_nodes</span> <span class="o">=</span> <span class="n">get_unique_nodes</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">unique_nodes</span><span class="p">:</span>
    <span class="c1"># then loop through and grab all the file names</span>
        <span class="n">node_set</span> <span class="o">=</span> <span class="n">grab_node_file_list</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="n">node</span><span class="p">)</span>
        <span class="n">h5_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_set</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">h5_list</span><span class="p">,</span> <span class="n">unique_nodes</span></div>


<span class="k">def</span> <span class="nf">get_unique_nodes</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;blc&quot;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;7&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>
                <span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

    <span class="n">node_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">node_set</span><span class="p">)</span>

    <span class="n">unique_nodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">node_set</span><span class="p">)</span>
    <span class="n">unique_nodes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">unique_nodes</span>

<div class="viewcode-block" id="grab_node_file_list"><a class="viewcode-back" href="../api.html#cappuccino.grab_node_file_list">[docs]</a><span class="k">def</span> <span class="nf">grab_node_file_list</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="n">node_number</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    returns h5 and dat file path from given directory, ordered correctly</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1">## h5 list</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.h5&#39;</span> <span class="ow">and</span> <span class="n">node_number</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
                
    <span class="n">data_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">data_list</span></div>



<span class="c1"># Define Global Constants here</span>

<span class="c1"># block size is how large of an area we are searching for signals in</span>
<span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">500</span>

<span class="c1"># edge is how far we will slide the two boundaries to match them up. On average there is a 30s slew time between observation.</span>
<span class="n">EDGE</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># significance level is how strong a signal must be so that we flag the area and do a more detailed filtering.</span>
<span class="n">SIGNIFICANCE_LEVEL</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># the minimum correlation score required to reject a signal as being strongly correlated.</span>
<span class="n">PEARSON_THRESHOLD</span> <span class="o">=</span> <span class="mf">.3</span>

<span class="c1"># this initializes the psosible edges we iterate over for the pearson. We start at zero and work our way out, so as to be time efficient.</span>
<span class="n">possible_drifts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">EDGE</span><span class="p">):</span>
    <span class="n">possible_drifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">possible_drifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>

<span class="c1">#,[2180,2200],[4000,4200],[10800,11000]]</span>
<span class="n">bad_regions</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">700</span><span class="p">,</span><span class="mi">830</span><span class="p">],[</span><span class="mi">1370</span><span class="p">,</span><span class="mi">1390</span><span class="p">],[</span><span class="mi">1520</span><span class="p">,</span><span class="mi">1630</span><span class="p">],[</span><span class="mi">1160</span><span class="p">,</span><span class="mi">1340</span><span class="p">],[</span><span class="mi">1675</span><span class="p">,</span><span class="mi">1695</span><span class="p">],[</span><span class="mi">2180</span><span class="p">,</span><span class="mi">2280</span><span class="p">],[</span><span class="mi">2025</span><span class="p">,</span><span class="mi">2035</span><span class="p">],[</span><span class="mi">2100</span><span class="p">,</span><span class="mi">2120</span><span class="p">],[</span><span class="mi">1915</span><span class="p">,</span><span class="mi">1935</span><span class="p">],[</span><span class="mi">2300</span><span class="p">,</span><span class="mi">2360</span><span class="p">],[</span><span class="mi">3800</span><span class="p">,</span><span class="mi">4200</span><span class="p">],[</span><span class="mi">4680</span><span class="p">,</span><span class="mi">4800</span><span class="p">],[</span><span class="mi">11000</span><span class="p">,</span><span class="mi">11180</span><span class="p">]]</span>


<span class="c1"># Define Necessary Functions</span>
<span class="k">def</span> <span class="nf">get_boundary_data</span><span class="p">(</span><span class="n">hf_ON</span><span class="p">,</span><span class="n">hf_OFF</span><span class="p">,</span><span class="n">lower</span><span class="p">,</span><span class="n">upper</span><span class="p">):</span>

    <span class="n">row_ON</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_ON</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">:,:,</span><span class="n">lower</span><span class="p">:</span><span class="n">upper</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">row_OFF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_OFF</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:</span><span class="mi">1</span><span class="p">,:,</span><span class="n">lower</span><span class="o">-</span><span class="n">EDGE</span><span class="p">:</span><span class="n">upper</span><span class="o">+</span><span class="n">EDGE</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">row_ON</span><span class="p">,</span><span class="n">row_OFF</span>


<span class="k">def</span> <span class="nf">get_last_time_row</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="n">last_time_row</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">last_time_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_freq_slices</span><span class="p">(</span><span class="n">last_time_row</span><span class="p">,</span><span class="n">f_start</span><span class="p">,</span><span class="n">f_end</span><span class="p">):</span>
    <span class="n">freq_block</span> <span class="o">=</span> <span class="n">last_time_row</span><span class="p">[</span><span class="n">f_start</span><span class="p">:</span><span class="n">f_end</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">freq_block</span>

<span class="k">def</span> <span class="nf">get_snr</span><span class="p">(</span><span class="n">sliced</span><span class="p">,</span><span class="n">sigma_multiplier</span><span class="p">):</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># divide by max to make numbers smaller</span>
    <span class="n">sliced</span> <span class="o">=</span> <span class="n">sliced</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sliced</span><span class="p">)</span>

    <span class="n">lower_quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">sliced</span><span class="p">,</span><span class="mf">.7</span><span class="p">)</span>
    <span class="n">lower_slice</span> <span class="o">=</span> <span class="n">sliced</span><span class="p">[</span><span class="n">sliced</span> <span class="o">&lt;</span> <span class="n">lower_quantile</span><span class="p">]</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lower_slice</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lower_slice</span><span class="p">)</span>

    <span class="c1"># print(&#39;sigma&#39;,sigma)</span>
    <span class="c1"># print(&#39;median&#39;,median)</span>
    <span class="c1"># print(&#39;sigma_multiplier&#39;,sigma_multiplier)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">median</span><span class="o">+</span><span class="n">sigma_multiplier</span><span class="o">*</span><span class="n">sigma</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sliced</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># plt.axhline(y=threshold)</span>
        <span class="c1"># plt.plot(slice)</span>
        <span class="c1"># plt.show()</span>

    <span class="k">return</span> <span class="n">snr</span><span class="p">,</span> <span class="n">threshold</span>

<span class="k">def</span> <span class="nf">get_first_round_snr</span><span class="p">(</span><span class="n">sliced</span><span class="p">,</span><span class="n">first_round_multiplier</span><span class="p">):</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># divide by max to make numbers smaller</span>
    <span class="n">sliced</span> <span class="o">=</span> <span class="n">sliced</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sliced</span><span class="p">)</span>

    <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sliced</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sliced</span><span class="p">)</span>

    <span class="c1"># print(&#39;sigma&#39;,sigma)</span>
    <span class="c1"># print(&#39;median&#39;,median)</span>
    <span class="c1"># print(&#39;sigma_multiplier&#39;,sigma_multiplier)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">median</span><span class="o">+</span><span class="n">first_round_multiplier</span><span class="o">*</span><span class="n">sigma</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># plt.axhline(y=threshold)</span>
        <span class="c1"># plt.plot(slice)</span>
        <span class="c1"># plt.show()</span>

    <span class="k">return</span> <span class="n">snr</span><span class="p">,</span> <span class="n">threshold</span>


<span class="k">def</span> <span class="nf">get_snr</span><span class="p">(</span><span class="n">sliced</span><span class="p">,</span><span class="n">sigma_multiplier</span><span class="p">):</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># divide by max to make numbers smaller</span>
    <span class="n">sliced</span> <span class="o">=</span> <span class="n">sliced</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sliced</span><span class="p">)</span>

    <span class="n">lower_quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">sliced</span><span class="p">,</span><span class="mf">.85</span><span class="p">)</span>
    <span class="n">lower_slice</span> <span class="o">=</span> <span class="n">sliced</span><span class="p">[</span><span class="n">sliced</span> <span class="o">&lt;</span> <span class="n">lower_quantile</span><span class="p">]</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">lower_slice</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lower_slice</span><span class="p">)</span>

    <span class="c1"># print(&#39;sigma&#39;,sigma)</span>
    <span class="c1"># print(&#39;median&#39;,median)</span>
    <span class="c1"># print(&#39;sigma_multiplier&#39;,sigma_multiplier)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">median</span><span class="o">+</span><span class="n">sigma_multiplier</span><span class="o">*</span><span class="n">sigma</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># plt.axhline(y=threshold)</span>
        <span class="c1"># plt.plot(slice)</span>
        <span class="c1"># plt.show()</span>

    <span class="k">return</span> <span class="n">snr</span><span class="p">,</span> <span class="n">threshold</span>
    
<span class="k">def</span> <span class="nf">find_hotspots</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>
    <span class="n">first_round</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hotspots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">first_round_multiplier</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="c1"># iterate</span>
    <span class="n">hotspot_size</span> <span class="o">=</span> <span class="mi">2000</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">number</span><span class="p">)):</span>
        <span class="n">slice_ON</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">BLOCK_SIZE</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BLOCK_SIZE</span><span class="p">:]</span>
        <span class="n">snr</span><span class="p">,</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">get_first_round_snr</span><span class="p">(</span><span class="n">slice_ON</span><span class="p">,</span><span class="n">first_round_multiplier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">snr</span><span class="p">:</span>
            <span class="n">first_round</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">first_round</span><span class="p">):</span>
        <span class="n">slice_ON</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">BLOCK_SIZE</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BLOCK_SIZE</span><span class="p">:]</span>
        <span class="n">snr</span><span class="p">,</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">slice_ON</span><span class="p">,</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">snr</span><span class="p">:</span>
            <span class="n">hotspots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    
    <span class="k">return</span> <span class="n">hotspots</span>

<span class="k">def</span> <span class="nf">get_file_properties</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">tstart</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]</span>
    <span class="n">fch1</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;fch1&#39;</span><span class="p">]</span>
    <span class="n">foff</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;foff&#39;</span><span class="p">]</span>
    <span class="n">nchans</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nchans&#39;</span><span class="p">]</span>
    <span class="n">ra</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;src_raj&#39;</span><span class="p">]</span>
    <span class="n">decl</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;src_dej&#39;</span><span class="p">]</span>
    <span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;source_name&#39;</span><span class="p">]</span>
    <span class="c1"># print(&quot;tstart %0.6f fch1 %0.10f foff %0.30f nchans %d cfreq %0.10f src_raj %0.10f src_raj_degs %0.10f src_dej %0.10f target %s&quot; % (tstart,fch1,foff,nchans,(fch1+((foff*nchans)/2.0)),ra,ra*15.0,decl,target))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start Channel: </span><span class="si">%0.10f</span><span class="s2"> Frequency Bin: </span><span class="si">%0.30f</span><span class="s2"> # Channels: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fch1</span><span class="p">,</span><span class="n">foff</span><span class="p">,</span><span class="n">nchans</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fch1</span><span class="p">,</span> <span class="n">foff</span>

<span class="k">def</span> <span class="nf">get_correct_index</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span><span class="n">fch1</span><span class="p">,</span><span class="n">foff</span><span class="p">):</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">fch1</span> <span class="o">-</span> <span class="n">freq</span>
    <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="o">-</span><span class="n">distance</span><span class="o">/</span><span class="n">foff</span><span class="p">))</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="mi">250</span>
    <span class="k">return</span> <span class="n">number</span><span class="o">+</span><span class="n">bound</span><span class="p">,</span> <span class="n">number</span><span class="o">-</span><span class="n">bound</span>

<div class="viewcode-block" id="filter_hotspots"><a class="viewcode-back" href="../api.html#cappuccino.filter_hotspots">[docs]</a><span class="k">def</span> <span class="nf">filter_hotspots</span><span class="p">(</span><span class="n">hotspots</span><span class="p">,</span><span class="n">fch1</span><span class="p">,</span><span class="n">foff</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Take out hotspots that are falling in especially heavy RFI</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">## first convert hotspots ids to frequency channels</span>
    <span class="n">hotspots_frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">((</span><span class="n">fch1</span><span class="o">+</span><span class="n">foff</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">500</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hotspots</span><span class="p">])</span>
    <span class="n">all_indexes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bad_regions</span><span class="p">:</span>
        <span class="c1"># print(bad_regions)</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">bottom</span><span class="o">&lt;</span><span class="n">hotspots_frequencies</span><span class="p">,</span> <span class="n">hotspots_frequencies</span><span class="o">&lt;</span><span class="n">top</span><span class="p">))</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
            <span class="n">all_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">all_indexes</span></div>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Event Detection algorithms</span>
<span class="sd">Nice and short :)</span>

<span class="sd"> &#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">check_hotspots</span><span class="p">(</span><span class="n">hf_obs1</span><span class="p">,</span><span class="n">hf_obs2</span><span class="p">,</span><span class="n">hf_obs3</span><span class="p">,</span><span class="n">hf_obs4</span><span class="p">,</span><span class="n">hf_obs5</span><span class="p">,</span><span class="n">hf_obs6</span><span class="p">,</span><span class="n">filtered_hotspots</span><span class="p">):</span>
    <span class="n">low_correlations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">.5</span>
    <span class="c1"># we iterate through all of the hotspots</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">filtered_hotspots</span><span class="p">):</span>

        <span class="c1"># define the block region we are looking at</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">500</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500</span> 

        
        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># load the observations for off and ON. Last time bin for first obs, first time bin for seond obs</span>
            <span class="c1"># also check other boundaries</span>


            <span class="n">row_ON</span><span class="p">,</span> <span class="n">row_OFF</span> <span class="o">=</span> <span class="n">get_boundary_data</span><span class="p">(</span><span class="n">hf_obs1</span><span class="p">,</span><span class="n">hf_obs2</span><span class="p">,</span><span class="n">lower</span><span class="p">,</span><span class="n">upper</span><span class="p">)</span>
            <span class="n">same_signal_number</span> <span class="o">=</span> <span class="n">check_same_signal_number</span><span class="p">(</span><span class="n">row_ON</span><span class="p">,</span><span class="n">row_OFF</span><span class="p">)</span>


            <span class="c1"># first just check if there are same number of signals</span>
            <span class="k">if</span> <span class="n">same_signal_number</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">Obs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_obs1</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">lower</span><span class="p">:</span><span class="n">upper</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># print(Obs1.shape)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checking blips&quot;</span><span class="p">)</span>
                <span class="n">not_constant_signal</span><span class="p">,</span><span class="n">threshold_blips</span> <span class="o">=</span> <span class="n">blip_checker</span><span class="p">(</span><span class="n">Obs1</span><span class="p">)</span>                

                <span class="k">if</span> <span class="n">not_constant_signal</span> <span class="o">==</span><span class="kc">False</span> <span class="p">:</span>
                    <span class="c1"># if it passes the initial check, perform pearson correlation</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking correlation&quot;</span><span class="p">)</span>
                    <span class="n">max_corr</span><span class="p">,</span> <span class="n">current_shift</span> <span class="o">=</span> <span class="n">pearson_slider</span><span class="p">(</span><span class="n">row_ON</span><span class="p">,</span><span class="n">row_OFF</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">max_corr</span> <span class="o">&lt;</span> <span class="n">PEARSON_THRESHOLD</span><span class="p">:</span>
                        <span class="c1"># Obs1 = np.squeeze(hf_obs1[&#39;data&#39;][:,:,lower:upper],axis=1)</span>
                        <span class="c1"># check if it is broadband RFI:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checking broadband&quot;</span><span class="p">)</span>
                        <span class="n">is_broadband</span> <span class="o">=</span> <span class="n">check_broadband</span><span class="p">(</span><span class="n">Obs1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">is_broadband</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            
                            <span class="c1"># load entire observation and see if time-summing the signal produces different result</span>
                            <span class="n">Obs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_obs2</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">lower</span><span class="o">-</span><span class="n">EDGE</span><span class="p">:</span><span class="n">upper</span><span class="o">+</span><span class="n">EDGE</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="c1"># will catch weak signals</span>
                            <span class="n">fails_sum</span><span class="p">,</span><span class="n">integrated_pearson_score</span> <span class="o">=</span> <span class="n">second_filter</span><span class="p">(</span><span class="n">Obs1</span><span class="p">,</span><span class="n">Obs2</span><span class="p">)</span>
                
                            <span class="c1"># then do a check that there is still a strong signal somewhere higher up in the observation --&gt; so not just a little point right at the boundary</span>
                            <span class="c1"># time sum whole observation, and see if signal stands out</span>
                
                            <span class="c1"># also check if there was just a dim signal in the first OFF, maybe it gets stronger in second bin</span>
                            <span class="n">second_row_corr</span><span class="p">,</span><span class="n">current_shift</span> <span class="o">=</span> <span class="n">pearson_slider</span><span class="p">(</span><span class="n">row_ON</span><span class="p">,</span><span class="n">Obs2</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
                            <span class="c1"># can also check if same # of signals in middle of next row</span>
                            <span class="n">check_same_signal_number_middle</span> <span class="o">=</span> <span class="n">check_same_signal_number</span><span class="p">(</span><span class="n">row_ON</span><span class="p">,</span><span class="n">Obs2</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
                            <span class="c1"># plt.plot(row_ON)</span>
                            <span class="c1"># plt.show()</span>
                            <span class="c1"># plt.plot(Obs2[8])</span>
                            <span class="c1"># plt.show()</span>

                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fails sum:&quot;</span><span class="p">,</span><span class="n">fails_sum</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not_constant_signal:&quot;</span><span class="p">,</span><span class="n">not_constant_signal</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;second_row_corr&quot;</span><span class="p">,</span><span class="n">second_row_corr</span><span class="p">)</span>
            
                            <span class="c1"># if it passes these tests, check if it zero drift rate. Compare first time from first ON observation to last time from last OFF.</span>
                            <span class="c1"># if it has high correlation at drift rate = 0, then probably not good </span>
                            <span class="k">if</span> <span class="n">fails_sum</span> <span class="ow">and</span> <span class="n">second_row_corr</span> <span class="o">&lt;</span> <span class="n">PEARSON_THRESHOLD</span> <span class="ow">and</span> <span class="n">check_same_signal_number_middle</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking Drift Rate&quot;</span><span class="p">)</span>
                
                                <span class="c1"># sum whole observation and see if zero drift rate, if necessary</span>
                                <span class="n">obs1_int</span> <span class="o">=</span> <span class="n">Obs1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
                                <span class="c1"># load last OFF observation</span>
                                <span class="n">Obs6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_obs6</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">lower</span><span class="o">-</span><span class="n">EDGE</span><span class="p">:</span><span class="n">upper</span><span class="o">+</span><span class="n">EDGE</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">obs6_int</span> <span class="o">=</span> <span class="n">Obs6</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
                                <span class="n">first_last_corr</span><span class="p">,</span><span class="n">current_shift</span> <span class="o">=</span> <span class="n">pearson_slider</span><span class="p">(</span><span class="n">obs1_int</span><span class="p">,</span> <span class="n">obs6_int</span><span class="p">)</span>
                
                                <span class="k">if</span> <span class="n">current_shift</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_shift</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                
                                    <span class="c1"># Final check will be to see if all the on signals are in the same place in all the off signals</span>
                                    <span class="c1"># time intensive bc we are loading all the data, so this is the very last check</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Second drift check&quot;</span><span class="p">)</span>
                                    <span class="n">Obs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_obs2</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">lower</span><span class="p">:</span><span class="n">upper</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">obs2_int</span> <span class="o">=</span> <span class="n">Obs2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
                                    <span class="n">Obs3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_obs3</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">lower</span><span class="p">:</span><span class="n">upper</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">obs3_int</span> <span class="o">=</span> <span class="n">Obs3</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
                                    <span class="n">Obs4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_obs4</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">lower</span><span class="p">:</span><span class="n">upper</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">obs4_int</span> <span class="o">=</span> <span class="n">Obs4</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
                                    <span class="n">Obs5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_obs5</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">lower</span><span class="p">:</span><span class="n">upper</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">obs5_int</span> <span class="o">=</span> <span class="n">Obs5</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
                                    <span class="n">Obs6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">hf_obs6</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">lower</span><span class="p">:</span><span class="n">upper</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">obs6_int</span> <span class="o">=</span> <span class="n">Obs6</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                    
                                    <span class="n">on_sum</span> <span class="o">=</span> <span class="n">obs1_int</span><span class="o">+</span><span class="n">obs3_int</span><span class="o">+</span><span class="n">obs5_int</span>
                                    <span class="n">off_sum</span> <span class="o">=</span> <span class="n">obs2_int</span><span class="o">+</span><span class="n">obs4_int</span><span class="o">+</span><span class="n">obs6_int</span>
                                    <span class="n">whole_sum</span> <span class="o">=</span> <span class="n">obs1_int</span><span class="o">+</span><span class="n">obs3_int</span><span class="o">+</span><span class="n">obs5_int</span><span class="o">+</span><span class="n">obs2_int</span><span class="o">+</span><span class="n">obs4_int</span><span class="o">+</span><span class="n">obs6_int</span>

                                    <span class="n">on_sum</span> <span class="o">=</span> <span class="n">on_sum</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">on_sum</span><span class="p">)</span>
                                    <span class="n">off_sum</span> <span class="o">=</span> <span class="n">off_sum</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">off_sum</span><span class="p">)</span>
                                    <span class="n">whole_sum</span> <span class="o">=</span> <span class="n">whole_sum</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">whole_sum</span><span class="p">)</span>

                                        
                                        

                                    <span class="n">zero_drift</span> <span class="o">=</span> <span class="n">drift_index_checker</span><span class="p">(</span><span class="n">whole_sum</span><span class="p">,</span> <span class="n">row_ON</span><span class="p">)</span>
                                    
                                    <span class="n">signal_stays_strong</span> <span class="o">=</span> <span class="kc">True</span>

                                    <span class="n">snr_obs3_0</span><span class="p">,</span> <span class="n">threshold30</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">Obs3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>
                                    <span class="n">snr_obs3_16</span><span class="p">,</span> <span class="n">threshold316</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">Obs3</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>
                                    <span class="n">snr_obs5_0</span><span class="p">,</span> <span class="n">threshold50</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">Obs5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>
                                    <span class="n">snr_obs5_16</span><span class="p">,</span> <span class="n">threshold516</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">Obs5</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>


                                    <span class="n">number_strong_boundaries</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;checking if signal peters out&quot;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">snr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">snr_obs3_0</span><span class="p">,</span><span class="n">snr_obs3_16</span><span class="p">,</span><span class="n">snr_obs5_0</span><span class="p">,</span><span class="n">snr_obs5_16</span><span class="p">]:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">snr</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                            <span class="n">number_strong_boundaries</span> <span class="o">+=</span> <span class="mi">1</span>

                                    <span class="nb">print</span><span class="p">(</span><span class="n">number_strong_boundaries</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">number_strong_boundaries</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
                                        <span class="n">signal_stays_strong</span> <span class="o">=</span> <span class="kc">False</span>

                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;zero drift&#39;</span><span class="p">,</span><span class="n">zero_drift</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span><span class="n">signal_stays_strong</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">zero_drift</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">signal_stays_strong</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> 
                                        <span class="c1"># check other boundaries</span>
                                        <span class="c1"># boundary 2/5</span>
                                        <span class="n">row_ON2</span><span class="p">,</span> <span class="n">row_OFF2</span> <span class="o">=</span> <span class="n">get_boundary_data</span><span class="p">(</span><span class="n">hf_obs2</span><span class="p">,</span><span class="n">hf_obs3</span><span class="p">,</span><span class="n">lower</span><span class="p">,</span><span class="n">upper</span><span class="p">)</span>

                                        

                                        <span class="n">max_corr2</span><span class="p">,</span> <span class="n">current_shift2</span> <span class="o">=</span> <span class="n">pearson_slider</span><span class="p">(</span><span class="n">row_ON2</span><span class="p">,</span><span class="n">row_OFF2</span><span class="p">)</span>
                                        <span class="c1"># boundary 3/5</span>
                                        <span class="n">row_ON3</span><span class="p">,</span> <span class="n">row_OFF3</span> <span class="o">=</span> <span class="n">get_boundary_data</span><span class="p">(</span><span class="n">hf_obs3</span><span class="p">,</span><span class="n">hf_obs4</span><span class="p">,</span><span class="n">lower</span><span class="p">,</span><span class="n">upper</span><span class="p">)</span>
                                        <span class="n">max_corr3</span><span class="p">,</span> <span class="n">current_shift3</span> <span class="o">=</span> <span class="n">pearson_slider</span><span class="p">(</span><span class="n">row_ON3</span><span class="p">,</span><span class="n">row_OFF3</span><span class="p">)</span>
                                        <span class="c1"># boundary 4/5</span>
                                        <span class="n">row_ON4</span><span class="p">,</span> <span class="n">row_OFF4</span> <span class="o">=</span> <span class="n">get_boundary_data</span><span class="p">(</span><span class="n">hf_obs4</span><span class="p">,</span><span class="n">hf_obs5</span><span class="p">,</span><span class="n">lower</span><span class="p">,</span><span class="n">upper</span><span class="p">)</span>
                                        <span class="n">max_corr4</span><span class="p">,</span> <span class="n">current_shift4</span> <span class="o">=</span> <span class="n">pearson_slider</span><span class="p">(</span><span class="n">row_ON4</span><span class="p">,</span><span class="n">row_OFF4</span><span class="p">)</span>
                                        <span class="c1"># boundary 5/5</span>
                                        <span class="n">row_ON5</span><span class="p">,</span> <span class="n">row_OFF5</span> <span class="o">=</span> <span class="n">get_boundary_data</span><span class="p">(</span><span class="n">hf_obs5</span><span class="p">,</span><span class="n">hf_obs6</span><span class="p">,</span><span class="n">lower</span><span class="p">,</span><span class="n">upper</span><span class="p">)</span>
                                        <span class="n">max_corr5</span><span class="p">,</span> <span class="n">current_shift5</span> <span class="o">=</span> <span class="n">pearson_slider</span><span class="p">(</span><span class="n">row_ON5</span><span class="p">,</span><span class="n">row_OFF5</span><span class="p">)</span>
                                        <span class="c1"># count how many had low pearson values</span>
                                        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

                                        <span class="k">for</span> <span class="n">corr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">max_corr</span><span class="p">,</span><span class="n">max_corr2</span><span class="p">,</span><span class="n">max_corr3</span><span class="p">,</span><span class="n">max_corr4</span><span class="p">,</span><span class="n">max_corr5</span><span class="p">]:</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;co:&#39;</span><span class="p">,</span><span class="n">corr</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">corr</span> <span class="o">&lt;</span> <span class="n">PEARSON_THRESHOLD</span><span class="p">:</span>
                                                <span class="n">score</span> <span class="o">+=</span><span class="mi">1</span> 
                
                
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;score:&#39;</span><span class="p">,</span><span class="n">score</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max correlation was </span><span class="si">{</span><span class="n">max_corr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;integrated correlation was </span><span class="si">{</span><span class="n">integrated_pearson_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;current shift:&#39;</span><span class="p">,</span><span class="n">current_shift</span><span class="p">)</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;firstlastcorr:&#39;</span><span class="p">,</span><span class="n">first_last_corr</span><span class="p">)</span>

                                        <span class="c1"># only return ones with low correlation on all boundaries</span>
                                        <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                                            <span class="n">low_correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX ERROR ON BLOCK # </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">)</span>

    

    <span class="k">return</span> <span class="n">low_correlations</span><span class="p">,</span> <span class="n">scores</span>


<span class="k">def</span> <span class="nf">check_broadband</span><span class="p">(</span><span class="n">obs1</span><span class="p">):</span>
    <span class="n">obs1_freq_integrated</span> <span class="o">=</span> <span class="n">obs1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">obs1_time_integrated</span> <span class="o">=</span> <span class="n">obs1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>

    <span class="n">blip_or_broadband</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># broadband will have a very high snr, can use ~100</span>
    <span class="n">broadband_threshold</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">freq_snr</span><span class="p">,</span> <span class="n">threshold_freq</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">obs1_freq_integrated</span><span class="p">,</span><span class="n">broadband_threshold</span><span class="p">)</span>

    <span class="c1"># also check it isnt a blip</span>
    <span class="n">time_snr</span><span class="p">,</span><span class="n">threshold_time</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">obs1_time_integrated</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">freq_snr</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">time_snr</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
    <span class="c1"># if freq_snr == True:</span>
        <span class="n">blip_or_broadband</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">blip_or_broadband</span>


<span class="k">def</span> <span class="nf">check_same_signal_number</span><span class="p">(</span><span class="n">row_ON</span><span class="p">,</span><span class="n">row_OFF</span><span class="p">):</span>
    
    <span class="n">row_ON</span> <span class="o">=</span> <span class="n">row_ON</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">row_ON</span><span class="p">)</span>
    <span class="n">row_OFF</span> <span class="o">=</span> <span class="n">row_OFF</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">row_OFF</span><span class="p">)</span>
    <span class="n">same_signal_number</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">snr1</span><span class="p">,</span> <span class="n">threshold1</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">row_ON</span><span class="p">,</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>
    <span class="n">snr6</span><span class="p">,</span> <span class="n">threshold6</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">row_OFF</span><span class="p">,</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>

    <span class="n">indicesON</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row_ON</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">indicesOFF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row_OFF</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold6</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicesON</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicesOFF</span><span class="p">):</span>
        <span class="c1"># print(&quot;same number of strong signals&quot;)</span>
        <span class="n">same_signal_number</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">same_signal_number</span>


<span class="k">def</span> <span class="nf">blip_checker</span><span class="p">(</span><span class="n">obs1</span><span class="p">):</span>
    <span class="n">blip_threshold</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="n">not_constant_signal</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># make sure there is a signal and not just blips</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">]:</span>
        <span class="n">int_snr</span><span class="p">,</span><span class="n">threshold2</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">obs1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">blip_threshold</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">int_snr</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">not_constant_signal</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">not_constant_signal</span><span class="p">,</span> <span class="p">(</span><span class="n">threshold2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pearson_slider</span><span class="p">(</span><span class="n">boundary_ON</span><span class="p">,</span><span class="n">boundary_OFF</span><span class="p">):</span>
    <span class="n">max_corr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_pearson</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_shift</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">boundary_ON</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">possible_drifts</span><span class="p">:</span>
        <span class="n">current_shift</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">EDGE</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">boundary_OFF</span><span class="p">[(</span><span class="n">EDGE</span><span class="o">+</span><span class="n">i</span><span class="p">):</span><span class="o">-</span><span class="p">(</span><span class="n">EDGE</span><span class="o">-</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">y</span> <span class="o">=</span> <span class="n">boundary_OFF</span><span class="p">[(</span><span class="n">EDGE</span><span class="o">+</span><span class="n">i</span><span class="p">):]</span>

        <span class="c1"># print(len(x),len(y))</span>

        <span class="n">x</span><span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">pearson</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

        <span class="n">pearson</span>  <span class="o">=</span> <span class="n">pearson</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pearson</span> <span class="o">&gt;</span> <span class="n">max_pearson</span><span class="p">:</span>
            <span class="n">max_pearson</span> <span class="o">=</span> <span class="n">pearson</span>
            <span class="k">if</span> <span class="n">pearson</span> <span class="o">&gt;</span> <span class="n">PEARSON_THRESHOLD</span><span class="p">:</span>
                <span class="c1"># print(&quot;ran iterations:&quot;,i)</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">max_pearson</span><span class="p">,</span> <span class="n">current_shift</span>

<span class="c1"># this performs a similar step as pearson but will check time sum and i</span>
<span class="k">def</span> <span class="nf">second_filter</span><span class="p">(</span><span class="n">obs1</span><span class="p">,</span><span class="n">obs2</span><span class="p">):</span>

    <span class="n">still_good</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># first try summing and checking correlation again --&gt; possible the signal was too weak the first time</span>
    <span class="n">obs1_time_integrated</span> <span class="o">=</span> <span class="n">obs1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">obs2_time_integrated</span> <span class="o">=</span> <span class="n">obs2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">integrated_pearson_score</span><span class="p">,</span> <span class="n">current_shift</span> <span class="o">=</span> <span class="n">pearson_slider</span><span class="p">(</span><span class="n">obs1_time_integrated</span><span class="p">,</span><span class="n">obs2_time_integrated</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">integrated_pearson_score</span> <span class="o">&lt;</span> <span class="n">PEARSON_THRESHOLD</span><span class="p">:</span>
        <span class="n">still_good</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">still_good</span><span class="p">,</span> <span class="n">integrated_pearson_score</span>

<span class="k">def</span> <span class="nf">drift_index_checker</span><span class="p">(</span><span class="n">whole_sum</span><span class="p">,</span> <span class="n">row_ON</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking Drift&quot;</span><span class="p">)</span>
    <span class="n">zero_drift</span> <span class="o">=</span> <span class="kc">False</span>


    <span class="c1"># row_ON = row_ON/np.max(row_ON)</span>
    <span class="c1"># obs1_int = obs1_int/np.max(obs1_int)</span>
    <span class="c1"># obs6_int = obs6_int/np.max(obs6_int)</span>


    <span class="c1"># # check if both the ons and offs have signal peaks in all the same places</span>
    <span class="c1"># snr1, threshold1 = get_snr(obs1_int,SIGNIFICANCE_LEVEL)</span>
    <span class="c1"># snr6, threshold6 = get_snr(obs1_int,SIGNIFICANCE_LEVEL)</span>

    <span class="c1"># indices1 = np.where(np.array(obs1_int) &gt; threshold1)[0].tolist()</span>
    <span class="c1"># indices6 = np.where(np.array(obs6_int) &gt; threshold6)[0].tolist()</span>

    <span class="c1"># # we need to avg the two that are close together</span>
    <span class="c1"># print(indices1,indices6)</span>
    <span class="c1"># if len(indices1) != 0 and len(indices6) != 0:</span>

    <span class="c1">#     filtered_indices1 = [indices1[0]]</span>
    <span class="c1">#     for i in indices1[1:]:</span>
    <span class="c1">#         if abs(filtered_indices1[-1] - i) &lt;2:</span>
    <span class="c1">#             filtered_indices1.pop()</span>
    <span class="c1">#             filtered_indices1.append(i-.5)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             filtered_indices1.append(i)</span>


    <span class="c1">#     filtered_indices6 = [indices6[0]]</span>
    <span class="c1">#     for i in indices6[1:]:</span>
    <span class="c1">#         if abs(filtered_indices6[-1] - i) &lt;2:</span>
    <span class="c1">#             filtered_indices6.pop()</span>
    <span class="c1">#             filtered_indices6.append(i-.5)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             filtered_indices6.append(i)</span>

    <span class="c1">#     if abs(np.mean(filtered_indices1)-np.mean(filtered_indices6)) &lt; 2:</span>
    <span class="c1">#         zero_drift = True</span>

    <span class="c1"># we can also check if when we sum the entire observation, we pick up the signal that set off the hotspot. </span>
    <span class="c1"># Will only do this if there are same number of peaks in on ROw and summed, in case there was a genuine signal in the ON row</span>

    <span class="n">hotspot_snr</span><span class="p">,</span> <span class="n">hotspot_threshold</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">row_ON</span><span class="p">,</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>
    <span class="n">summed_snr</span><span class="p">,</span> <span class="n">summed_threshold</span> <span class="o">=</span> <span class="n">get_snr</span><span class="p">(</span><span class="n">whole_sum</span><span class="p">,</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="p">)</span>

    <span class="n">hotspot_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row_ON</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">hotspot_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">summed_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">whole_sum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">summed_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># do same filtering as above</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hotspot_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">summed_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">filtered_hotspot_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">hotspot_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hotspot_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">filtered_hotspot_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">filtered_hotspot_indices</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">filtered_hotspot_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filtered_hotspot_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


        <span class="n">filtered_summed_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">summed_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">summed_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">filtered_summed_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">filtered_summed_indices</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">filtered_summed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filtered_summed_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># check if all hotspots picked up in ON row are in the summed</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">filtered_summed_indices</span><span class="p">,</span> <span class="n">filtered_hotspot_indices</span><span class="p">)</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filtered_hotspot_indices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">filtered_summed_indices</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">all</span> <span class="o">+=</span><span class="mi">1</span> 
        <span class="k">if</span> <span class="nb">all</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_hotspot_indices</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ZERO DRIFT&quot;</span><span class="p">)</span>
            <span class="n">zero_drift</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">zero_drift</span>


<span class="k">def</span> <span class="nf">main_boundary_checker</span><span class="p">(</span><span class="n">obs1</span><span class="p">,</span><span class="n">obs2</span><span class="p">,</span><span class="n">obs3</span><span class="p">,</span><span class="n">obs4</span><span class="p">,</span><span class="n">obs5</span><span class="p">,</span><span class="n">obs6</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Now running on &quot;</span><span class="p">,(</span><span class="n">obs1</span><span class="p">,</span><span class="n">obs2</span><span class="p">,</span><span class="n">obs3</span><span class="p">,</span><span class="n">obs4</span><span class="p">,</span><span class="n">obs5</span><span class="p">,</span><span class="n">obs6</span><span class="p">))</span>

    
    <span class="c1"># load data</span>
    <span class="n">hf_ON</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">obs1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">hf_OFF</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">obs2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">hf_ON2</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">obs3</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">hf_OFF2</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">obs4</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">hf_ON3</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">obs5</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">hf_OFF3</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">obs6</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>



    <span class="c1"># grab last row to find hotspots</span>
    <span class="n">last_time_row_ON</span> <span class="o">=</span> <span class="n">get_last_time_row</span><span class="p">(</span><span class="n">obs1</span><span class="p">)</span>

    <span class="c1"># find file frequency information</span>
    <span class="n">fch1</span><span class="p">,</span><span class="n">foff</span> <span class="o">=</span> <span class="n">get_file_properties</span><span class="p">(</span><span class="n">hf_ON</span><span class="p">)</span>

    <span class="c1"># calculate number of iterations needed and find hotspots</span>
    <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_time_row_ON</span><span class="p">)</span><span class="o">/</span><span class="n">BLOCK_SIZE</span><span class="p">))</span>
    <span class="c1"># record interesting freq chunks</span>
    <span class="n">hotspots_ON</span> <span class="o">=</span> <span class="n">find_hotspots</span><span class="p">(</span><span class="n">last_time_row_ON</span><span class="p">,</span><span class="n">number</span><span class="p">)</span>
    <span class="c1"># hotspots_OFF = find_hotspots(last_time_row_OFF)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# of hotspots:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">hotspots_ON</span><span class="p">))</span>
    <span class="c1"># filter the hotspots</span>
    <span class="n">filtered_indexes</span> <span class="o">=</span> <span class="n">filter_hotspots</span><span class="p">(</span><span class="n">hotspots_ON</span><span class="p">,</span><span class="n">fch1</span><span class="p">,</span><span class="n">foff</span><span class="p">)</span>
    <span class="n">filtered_hotspots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">hotspots_ON</span><span class="p">,</span> <span class="n">filtered_indexes</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# post filtering&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_hotspots</span><span class="p">))</span>

    <span class="c1"># find regions of low correlation</span>
    <span class="n">low_correlations</span><span class="p">,</span><span class="n">scores</span> <span class="o">=</span> <span class="n">check_hotspots</span><span class="p">(</span><span class="n">hf_ON</span><span class="p">,</span><span class="n">hf_OFF</span><span class="p">,</span><span class="n">hf_ON2</span><span class="p">,</span><span class="n">hf_OFF2</span><span class="p">,</span><span class="n">hf_ON3</span><span class="p">,</span><span class="n">hf_OFF3</span><span class="p">,</span><span class="n">filtered_hotspots</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">low_correlations</span><span class="p">)</span><span class="si">}</span><span class="s2"> regions of low correlation&quot;</span><span class="p">)</span>

    <span class="c1"># save regions to csv file, in current directory</span>

    <span class="c1"># return frequency positions of candidates</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">fch1</span><span class="o">+</span><span class="n">foff</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">500</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">low_correlations</span><span class="p">],</span><span class="n">scores</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    
    <span class="c1"># check if candidates database is set up, if not then initialize it</span>
    <span class="n">main_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="n">df_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;second_updated_candidate_events_sigma_</span><span class="si">{</span><span class="n">SIGNIFICANCE_LEVEL</span><span class="si">}</span><span class="s1">_pearsonthreshold_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">PEARSON_THRESHOLD</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s1">_blocksize_</span><span class="si">{</span><span class="n">BLOCK_SIZE</span><span class="si">}</span><span class="s1">_edge_</span><span class="si">{</span><span class="n">EDGE</span><span class="si">}</span><span class="s1">.csv&#39;</span>

    <span class="n">db_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">main_dir</span><span class="o">+</span><span class="n">df_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db_exists</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating candidates database as &quot;</span><span class="p">,</span><span class="n">df_name</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Primary File&quot;</span><span class="p">,</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span><span class="s2">&quot;All Files&quot;</span><span class="p">,</span><span class="s2">&quot;Score&quot;</span><span class="p">])</span>
        <span class="n">candidates</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">main_dir</span><span class="o">+</span><span class="n">df_name</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">main</span><span class="p">(</span><span class="n">df_name</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Cappuccino</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Caleb Painter.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>